---
title: "Creating Operating Models from BAM Output"
output: 
  bookdown::html_document2:
      base_format: rmarkdown::html_vignette
pkgdown:
  as_is: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message=FALSE, warning=FALSE}
library(SAMSE)
```

# Introduction

This article describes the process to import output from the Beaufort Assessment Model (BAM) and create the multi-species and multi-fleet operating models (OMs) using the [openMSE](https://openMSE.com) framework.


## Prerequistes

The latest development versions of `MSEtool` and `bamExtras` need to be installed from GitHub:

```{r, eval=FALSE, echo=TRUE}
# install.packages('pak')
pak::pkg_install('nikolaifish/bamExtras')
pak::pkg_install('blue-matter/MSEtool')

```

# OM Specifications

The number of simulations (`nsim`) and number of projection years (`proyears`) need to be specified for an OM. Here we are setting them as global variables so that each OM we create has the same number of stochastic simulations and projection years:

```{r}
nsim <- 100 # number of simulations
proyears <- 25 # number of projection years
```

An OM also requires the specification of an Observation Model. The Observation Model is used to simulate fishery data to be used be management procedures in the projection phase of the closed-loop simulation testing. 

We are using `Perfect_Info` as the fishery data are not currently used within the management options (only static management options are currently being explored). This can be changed later if dynamic management options that respond to the observed fishery data are added to the analysis. 

```{r}
Obs_Model <- Perfect_Info
```

# Case Study Stocks

The current analysis is focused on three stocks: Red snapper *Lutjanus campechanus*, Gag grouper *Mycteroperca microlepis*, and Black seabass *Centropristis striata*. The MSE framework is flexible, and more stocks can be added to the analysis following the same process used here.

Here we demonstrate creating OMs for the three case study stocks.

The most recent BAM assessments are used:

1. Red snapper: [SEDAR 73](https://sedarweb.org/documents/sedar-73-stock-assessment-report-south-atlantic-red-snapper/)
1. Gag grouper: [SEDAR 71](https://sedarweb.org/documents/sedar-71-stock-assessment-report-south-atlantic-gag/)
1. Black seabass: [SEDAR 76](https://sedarweb.org/documents/sedar-76-stock-assessment-report-south-atlantic-black-sea-bass/)


# Import SEDAR Assessments

The BAM assessments are imported from the `bamExtras` package:

```{r}
rdat_RS <- bamExtras::rdat_RedSnapper |> bamExtras::standardize_rdat()
rdat_GG <- bamExtras::rdat_GagGrouper |> bamExtras::standardize_rdat() 
rdat_BS <- bamExtras::rdat_BlackSeaBass |> bamExtras::standardize_rdat() 
```

# Create Single-Stock Operating Models

The `BAM2MOM` function is used to create the `openMSE` operating model objects:

```{r message=FALSE, warning=FALSE}
OM_RS <- BAM2MOM(rdat_RS, stock_name='Red Snapper', Obs=Obs_Model)
OM_GG <- BAM2MOM(rdat_GG, stock_name='Gag Grouper', Obs=Obs_Model)
OM_BS <- BAM2MOM(rdat_BS, stock_name='Black Seabass', Obs=Obs_Model)
```

These OMs could now be used within the `openMSE` framework. However, if we wish to combine the OMs into a single multi-stock OM (or model them individually under the assumption they are being managed together), we need to create a common fleet structure for all OMs.

## Define Fleet Structure

Here we create a data frame with the names of the fleets within each OM:
```{r}

fleet_names_df <- dplyr::bind_rows(
  data.frame(Stock='Red Snapper', Fleets=names(OM_RS@Fleets[[1]])),
  data.frame(Stock='Gag Grouper', Fleets=names(OM_GG@Fleets[[1]])),
  data.frame(Stock='Black Seabass', Fleets=names(OM_BS@Fleets[[1]]))
)

fleet_names_df |> dplyr::filter(Stock=='Red Snapper')
fleet_names_df |> dplyr::filter(Stock=='Gag Grouper')
fleet_names_df |> dplyr::filter(Stock=='Black Seabass')

```

In order to combine these single stock OMs together,  each OM must have the same fleet structure for all 
stocks in the OM, even if those fleets are not actively fishing on a particular stock.

The stocks have some fleets in common (e.g., Commercial hook and line (cHL)) and some unique fleets (e.g., Gag Grouper Commercial dive (cDV)). The landings and discards are also modeled as separate fleets in the BAM models (indicated by '.D').


The Black Seabass stock has two commercial fleets (cHL and cPT), but the discards are reported for two fleets combined (cGN.D). To deal with this, the cHL and cPT landing fleets will first be combined together, before the discards are added for the combined fleet. 

Here we create a data frame with `Code`, `Name`, `Mapping`, and `Type` for each fleet: 
```{r}
fleet_df <- data.frame(Code=unique(fleet_names_df$Fleets))

fleet_df$Name <- c('Commercial Line',
                   'Recreational Headboat',
                   'General Recreational',
                   'Commercial Line - Discard',
                   'Recreational Headboat - Discard',
                   'General Recreational - Discard',
                   'Commercial Dive',
                   'Commercial Pot',
                   'Commercial General - Discard')

fleet_df$Mapping <- c(1,2,3,1,2,3,4,1,1)
fleet_df$Type <- 'Landing'
fleet_df$Type[grepl('\\.D', fleet_df$Code)] <- 'Discard'
fleet_df
```

`Code` is the name of the fleets within the OM objects. `Name` is the name we are associating with each `Code`. The `Mapping` variable describes how the fleets will be combined together. `Type` indicates if a fleet in the OM represents Landings or Discards.

The Landing and Discard components for each fleet will be combined into a single fleet with a selectivity and retention curve. This makes it easier to model changes to management such as changes to season lengths, discard mortality, or size-based retention or selectivity regulations. 

The end result will be a fleet structure with four fleets for each stock:

1. Commercial Line
2. Recreational Headboat
3. General Recreational
4. Commercial Dive

## Define Discard Mortality 

The discard mortality needs to be added to the OMs so that the historical effort can be adjusted to account for the fish that were caught and released alive, and so that the discard mortality can be modified in the projections.

The discard mortality for Red Snapper is reported in Table 6 of [SEDAR 73](https://sedarweb.org/documents/sedar-73-stock-assessment-report-south-atlantic-red-snapper/). The`Year` variable indicates the first year the discard mortality changes:

```{r}
discard_mortality_RS <- dplyr::bind_rows(
  data.frame(Stock='Red Snapper',
             Code='cHL',
             Year=c(1900, 2007, 2017),
             Prob_Dead=c(0.48, 0.38, 0.36)),
  data.frame(Stock='Red Snapper',
             Code='rHB',
             Year=c(1900, 2011, 2018),
             Prob_Dead=c(0.37, 0.26, 0.25)),
  data.frame(Stock='Red Snapper',
             Code='rGN',
             Year=c(1900, 2011, 2018),
             Prob_Dead=c(0.37, 0.28, 0.26))
)
```

The discard mortality for Gag Grouper is reported in [SEDAR 71](https://sedarweb.org/documents/sedar-71-stock-assessment-report-south-atlantic-gag/), with a fixed discard mortality of 0.4 for the commerical fleet, and 0.25 for the recreational fleets for all years:

```{r}
discard_mortality_GG <- dplyr::bind_rows(
  data.frame(Stock='Gag Grouper',
             Code='cHL',
             Year=1900,
             Prob_Dead=0.4),
  data.frame(Stock='Gag Grouper',
             Code='rHB',
             Year=1900,
             Prob_Dead=0.25),
  data.frame(Stock='Gag Grouper',
             Code='rGN',
             Year=1900,
             Prob_Dead=0.25)
)

```

The discard mortality for Black Seabass is reported in Section 2.2.1 in [SEDAR 76](https://sedarweb.org/documents/sedar-76-stock-assessment-report-south-atlantic-black-sea-bass/). Here the average discard mortality is calculated for the combined commercial line and pot fleets: 

```{r}
discard_mortality_BS <- dplyr::bind_rows(
  data.frame(Stock='Black Seabass',
             Code='cHL',
             Year=c(1900, 2007),
             Prob_Dead=c(mean(0.14,0.19), mean(0.14, 0.068))
             ),
  data.frame(Stock='Black Seabass',
             Code='rHB',
             Year=1900,
             Prob_Dead=0.152),
  data.frame(Stock='Black Seabass',
             Code='rGN',
             Year=1900,
             Prob_Dead=0.137)
)
```

The stock-specific discard mortality dataframes are combined together:
```{r}
discard_mortality <- dplyr::bind_rows(discard_mortality_RS,
                                      discard_mortality_GG,
                                      discard_mortality_BS)

```

## Aggregate Fleets 

Next, the `Aggregate_Fleets` function is used to aggregate the fleets together according to the mapping defined in `fleet_df` and the discard mortality are added from `discard_mortality`.

The `Aggregate_Fleets` function does five things:

1. Combine any landing fleets that are mapped together in `fleet_df` (here only applies to Black Seabass)
2. Add the discard mortality to each fleet
3. Combine the discard fleets with the landing fleets to produce a single fleet with selectivity and retention curves
4. Add dummy fleets (F=0 for all years) for OMs that are missing some fleets
5. Order the fleets for all OMs

```{r}
OM_RS <- Aggregate_Fleets(OM_RS, fleet_df, discard_mortality)
OM_GG <- Aggregate_Fleets(OM_GG, fleet_df, discard_mortality)
OM_BS <- Aggregate_Fleets(OM_BS, fleet_df, discard_mortality)
```

# Add Spatial Structure

The spatial structure of the MSE has been defined as 6 areas, including 3 geographic regions  and a Nearshore (<100ft) and Offshore (>100ft) component for each region (solid and dashed black lines respectively in Figure \@ref(fig:spatialmap)).

```{r spatialmap, message=FALSE, warning=FALSE, cache=TRUE, fig.cap='Definition of spatial areas used in the MSE.', fig.width=8}
require(marmap)

bathy <- marmap::getNOAA.bathy(-83, -71.37133, 23.8, 36.55028)

numbers <- data.frame(Number=1:6,
                      x=c(-79.5, -77.7, -81, -80.3, -82, -80.3),
                      y=c(33, 33, 30, 30, 25, 25))

map <- ggplot()+
  geom_raster(data=bathy, aes(x=x, y=y,fill=z)) +
  coord_sf() +
  marmap::scale_fill_etopo() +
  guides(fill='none') +
  ggnewscale::new_scale_fill() +
  geom_polygon(data =  Spatial_Area_Definition(),
               aes(x = X, y = Y, group=Region, fill=Region), alpha=0.5) +
  scale_fill_manual(values= c('#7fc97f', '#beaed4', '#fdc086')) +
  geom_contour(data=bathy, aes(x=x, y=y, z=z), breaks=c(-30), 
               colour="black",linewidth=0.2) +
  geom_contour(data=bathy, aes(x=x, y=y, z=z), breaks=c(-300), 
               colour="black",linewidth=0.2, linetype=2) +
  geom_text(data=numbers, aes(x=x, y=y, label=Number), size=5) +
    scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  labs(x='Longitude', y='Latitude') +
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))

map
```


## Spatial Distribution of Unfished Abundance

The relative abundance of the three stocks was specified using the output of a recent study that estimated the spatiotemporal dynamics of reef fish off the southeastern United States ([Cao et al., 2024](https://esajournals.onlinelibrary.wiley.com/doi/10.1002/ecs2.4868); K. Shertzer personal communication, May 2024). 

```{r}
Rel_Abun_Area_RS <- data.frame(
  Area=1:6,
  Region=c(rep('North and South Carolina',2),
           rep('Georgia - Cape Canaveral',2),
           rep('Cape Canaveral - Florida',2)),
  Depth=c('Nearshore', 'Offshore'),
  Stock='Red Snapper',
  Proportion=c(0.03,0.01, 0.7, 0.19, 0.03, 0.04)
)

Rel_Abun_Area_GG <- data.frame(
  Area=1:6,
  Region=c(rep('North and South Carolina',2),
           rep('Georgia - Cape Canaveral',2),
           rep('Cape Canaveral - Florida',2)),
  Depth=c('Nearshore', 'Offshore'),
  Stock='Gag Grouper',
  Proportion=c(0.34, 0.21, 0.21, 0.18, 0.03, 0.03)
)

Rel_Abun_Area_BS <- data.frame(
  Area=1:6,
  Region=c(rep('North and South Carolina',2),
           rep('Georgia - Cape Canaveral',2),
           rep('Cape Canaveral - Florida',2)),
  Depth=c('Nearshore', 'Offshore'),
  Stock='Black Seabass',
  Proportion=c(0.14, 0.02, 0.72, 0.06, 0.04, 0.02)
)

```


## Add Stock Spatial Structure to OMs

The age-specific relative distribution of each stock across the depth zones was modeled by assuming 100%, 95%, and 80% of age-0, -1, and -2 fish respectively occurred in the nearshore region. The depth distribution of age-3+ fish, as well as the relative spatial distribution of the fishing fleets, were then calculated by optimizing the age-3+ stock and effort spatial distributions such that the relative distribution of the biomass across the six areas in the terminal year of the operating models closely matched the reported relative distribution from the spatiotemporal model (see above). 

```{r, addstockspatial, cache=TRUE, cache.extra = digest::digest(list(OM_RS,OM_GG, OM_BS,Rel_Abun_Area_RS, Rel_Abun_Area_GG, Rel_Abun_Area_BS))}
OM_RS <- Add_Spatial_to_OM(OM_RS, Rel_Abun_Area_RS)
                             
OM_GG <- Add_Spatial_to_OM(OM_GG, Rel_Abun_Area_GG)

OM_BS <- Add_Spatial_to_OM(OM_BS, Rel_Abun_Area_BS)

```


# Generate Correlated Recruitment Deviations for Projections

A multivariate normal distribution (truncated at 2 standard deviations) was used to estimate the variance and auto-correlation in the estimated recruitment deviations, together with the correlation in recruitment deviations between the three stocks. This distribution was then used to generate recruitment deviations for the projection period, maintaining the statistic properties of the historical recruitment deviations estimated in the stock assessments (Figure \@ref(fig:recdevs)). 

```{r recdevs, fig.cap='Scatterplots with marginal distributions showing the correlated recruitment deviations used for the projections.', fig.width=8}
OMList <- Generate_Correlated_Rec_Devs(list(OM_RS, OM_GG, OM_BS), truncsd=2)
OM_RS <- OMList[[1]]
OM_GG <- OMList[[2]]
OM_BS <- OMList[[3]]
  
Plot_Correlated_Rec_Devs(OMList)

```


# Compare BAM and OM Dynamics

Three single-stock, multi-fleet operating models have now been created. The next thing is to confirm that the fishery dynamics generated by the operating model are sufficiently close to those estimated in the BAM output.

Here the `Simulate` function is used to simulate the historical fishery dynamics described in the OM, and the 
`Compare_Biomass` function creates a plot to compare the biomass from the OM with those from the BAM output. 

The plots show that the biomass generated by the OMs closely matches the biomass reported by the stock assessments. The minor differences between the two are caused by the spatial structure being imposed onto the output of a non-spatial stock assessment.

```{r compareRS, fig.width=6}
Hist_RS <- Simulate(OM_RS, silent = TRUE, nsim=2)
Compare_Biomass(Hist_RS, rdat_RS)
```

```{r compareGG, fig.width=6}
Hist_GG <- Simulate(OM_GG, silent = TRUE, nsim=2)
Compare_Biomass(Hist_GG, rdat_GG)
```

```{r compare BS,fig.width=6}
Hist_BS <- Simulate(OM_BS, silent = TRUE, nsim=2)
Compare_Biomass(Hist_BS, rdat_BS)
```


# Save the Operating Models 

```{r saveOMs, eval=FALSE}
saveRDS(OM_RS, 'OM_RS.rda')
saveRDS(OM_GG,'OM_GG.rda')
saveRDS(OM_BS,'OM_BS.rda')
```


```{r saveOMs2, include=FALSE}
if (interactive())
if (isTRUE(getOption('knitr.in.progress'))) {
  saveRDS(OM_RS, '../../inst/OM_RS.rda')
  saveRDS(OM_GG,'../../inst/OM_GG.rda')
  saveRDS(OM_BS,'../../inst/OM_BS.rda')
} else {
  saveRDS(OM_RS, 'inst/OM_RS.rda')
  saveRDS(OM_GG,'inst/OM_GG.rda')
  saveRDS(OM_BS,'inst/OM_BS.rda')
}

```


